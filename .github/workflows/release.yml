name: Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  # ── Web build ──────────────────────────────────────────────
  build-web:
    name: Build Web
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - uses: Swatinem/rust-cache@v2

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: web/pnpm-lock.yaml

      - name: Build WASM (release)
        run: wasm-pack build demucs-wasm --release --target web --out-dir ../web/src/wasm

      - name: Build web app
        working-directory: web
        run: |
          pnpm install
          pnpm exec vite build --base=/demucs-rs/

      - name: Upload web artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: web/dist

  # ── Deploy to GitHub Pages ─────────────────────────────────
  deploy-pages:
    name: Deploy Pages
    needs: build-web
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}
    steps:
      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4

  # ── CLI binaries (matrix) ──────────────────────────────────
  build-cli:
    name: CLI (${{ matrix.target }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-apple-darwin
            runner: macos-latest
            archive: tar.gz

          - target: x86_64-unknown-linux-gnu
            runner: ubuntu-latest
            archive: tar.gz

          - target: x86_64-pc-windows-msvc
            runner: windows-latest
            archive: zip

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}

      - name: Install Vulkan SDK (Linux)
        if: runner.os == 'Linux'
        run: |
          wget -qO- https://packages.lunarg.com/lunarg-signing-key-pub.asc | sudo tee /etc/apt/trusted.gpg.d/lunarg.asc
          sudo wget -qO /etc/apt/sources.list.d/lunarg-vulkan-noble.list http://packages.lunarg.com/vulkan/lunarg-vulkan-noble.list
          sudo apt-get update
          sudo apt-get install -y vulkan-sdk

      - name: Install Vulkan SDK (Windows)
        if: runner.os == 'Windows'
        uses: humbletim/install-vulkan-sdk@v1.2

      - name: Build CLI
        env:
          CARGO_TARGET_AARCH64_APPLE_DARWIN_RUSTFLAGS: ""
          CARGO_TARGET_X86_64_APPLE_DARWIN_RUSTFLAGS: ""
        run: cargo build -p demucs-cli --release --target ${{ matrix.target }}

      - name: Package (unix)
        if: matrix.archive == 'tar.gz'
        run: |
          cd target/${{ matrix.target }}/release
          tar czf ../../../demucs-${{ matrix.target }}.tar.gz demucs
          cd ../../..

      - name: Package (windows)
        if: matrix.archive == 'zip'
        shell: pwsh
        run: |
          Compress-Archive -Path target/${{ matrix.target }}/release/demucs.exe -DestinationPath demucs-${{ matrix.target }}.zip

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: demucs-${{ matrix.target }}
          path: demucs-${{ matrix.target }}.${{ matrix.archive }}

  # ── Plugin bundles (macOS only) ─────────────────────────────
  build-plugin:
    name: Plugin (macOS)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - uses: Swatinem/rust-cache@v2
        with:
          key: plugin-macos

      - name: Bundle plugin
        run: cargo xtask bundle demucs-plugin --release --target aarch64-apple-darwin

      - name: Package plugin bundles
        run: |
          cd target/bundled
          zip -r ../../Demucs-vst3-aarch64-apple-darwin.zip Demucs.vst3
          zip -r ../../Demucs-clap-aarch64-apple-darwin.zip Demucs.clap

      - name: Upload plugin artifact
        uses: actions/upload-artifact@v4
        with:
          name: demucs-plugin-macos
          path: |
            Demucs-vst3-aarch64-apple-darwin.zip
            Demucs-clap-aarch64-apple-darwin.zip

  # ── GitHub Release ─────────────────────────────────────────
  create-release:
    name: Create Release
    needs: [build-cli, build-plugin]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: artifacts/*
